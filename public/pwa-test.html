<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PWA è¯Šæ–­å·¥å…·</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #0a0a1a;
      color: #fff;
    }
    .section {
      background: #1a1a2e;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      border: 1px solid #333;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 14px;
      margin-left: 10px;
    }
    .success { background: #10b981; color: #fff; }
    .error { background: #ef4444; color: #fff; }
    .warning { background: #f59e0b; color: #000; }
    button {
      background: #a3e635;
      color: #000;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin: 10px 10px 10px 0;
    }
    button:hover {
      background: #84cc16;
    }
    pre {
      background: #000;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>ğŸ” PWA è¯Šæ–­å·¥å…·</h1>
  
  <div class="section">
    <h2>1. Service Worker çŠ¶æ€</h2>
    <div id="sw-status">æ£€æŸ¥ä¸­...</div>
  </div>
  
  <div class="section">
    <h2>2. Manifest çŠ¶æ€</h2>
    <div id="manifest-status">æ£€æŸ¥ä¸­...</div>
  </div>
  
  <div class="section">
    <h2>3. å®‰è£…æç¤ºäº‹ä»¶</h2>
    <div id="prompt-status">ç­‰å¾… beforeinstallprompt äº‹ä»¶...</div>
    <button id="install-btn" style="display:none;">æ‰‹åŠ¨è§¦å‘å®‰è£…</button>
  </div>
  
  <div class="section">
    <h2>4. æµè§ˆå™¨ä¿¡æ¯</h2>
    <div id="browser-info"></div>
  </div>
  
  <div class="section">
    <h2>5. è¯Šæ–­å»ºè®®</h2>
    <div id="suggestions"></div>
  </div>

  <script>
    let deferredPrompt;
    const suggestions = [];

    // æ£€æŸ¥ Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(registrations => {
        const swStatus = document.getElementById('sw-status');
        if (registrations.length > 0) {
          swStatus.innerHTML = `<span class="status success">âœ“ å·²æ³¨å†Œ</span><br>` +
            `<small>æ•°é‡: ${registrations.length}</small>`;
        } else {
          swStatus.innerHTML = `<span class="status error">âœ— æœªæ³¨å†Œ</span>`;
          suggestions.push('Service Worker æœªæ³¨å†Œï¼Œè¯·æ£€æŸ¥ vite-plugin-pwa é…ç½®');
        }
      });
    } else {
      document.getElementById('sw-status').innerHTML = 
        `<span class="status error">âœ— ä¸æ”¯æŒ</span>`;
      suggestions.push('æµè§ˆå™¨ä¸æ”¯æŒ Service Worker');
    }

    // æ£€æŸ¥ Manifest
    fetch('/manifest.webmanifest')
      .then(res => res.json())
      .then(manifest => {
        const manifestStatus = document.getElementById('manifest-status');
        const checks = [];
        
        if (manifest.name) checks.push('âœ“ name');
        else { checks.push('âœ— name'); suggestions.push('manifest ç¼ºå°‘ name'); }
        
        if (manifest.icons && manifest.icons.length >= 2) checks.push('âœ“ icons');
        else { checks.push('âœ— icons'); suggestions.push('manifest å›¾æ ‡ä¸è¶³ï¼ˆéœ€è¦ 192px å’Œ 512pxï¼‰'); }
        
        if (manifest.start_url) checks.push('âœ“ start_url');
        else { checks.push('âœ— start_url'); suggestions.push('manifest ç¼ºå°‘ start_url'); }
        
        if (manifest.display) checks.push('âœ“ display');
        else { checks.push('âœ— display'); suggestions.push('manifest ç¼ºå°‘ display'); }
        
        manifestStatus.innerHTML = `<span class="status success">âœ“ å·²åŠ è½½</span><br>` +
          `<small>${checks.join(' | ')}</small><br>` +
          `<pre>${JSON.stringify(manifest, null, 2)}</pre>`;
      })
      .catch(err => {
        document.getElementById('manifest-status').innerHTML = 
          `<span class="status error">âœ— åŠ è½½å¤±è´¥</span><br><small>${err.message}</small>`;
        suggestions.push('manifest.webmanifest æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®');
      });

    // ç›‘å¬ beforeinstallprompt
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      const promptStatus = document.getElementById('prompt-status');
      promptStatus.innerHTML = `<span class="status success">âœ“ äº‹ä»¶å·²è§¦å‘</span><br>` +
        `<small>å¯ä»¥å®‰è£… PWAï¼</small>`;
      
      document.getElementById('install-btn').style.display = 'inline-block';
    });

    // æ‰‹åŠ¨å®‰è£…
    document.getElementById('install-btn').addEventListener('click', async () => {
      if (!deferredPrompt) return;
      
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      
      document.getElementById('prompt-status').innerHTML += 
        `<br><small>ç”¨æˆ·é€‰æ‹©: ${outcome}</small>`;
      
      deferredPrompt = null;
    });

    // æµè§ˆå™¨ä¿¡æ¯
    const browserInfo = document.getElementById('browser-info');
    browserInfo.innerHTML = `
      <small>
        User Agent: ${navigator.userAgent}<br>
        æ˜¯å¦ HTTPS: ${location.protocol === 'https:' ? 'âœ“ æ˜¯' : 'âœ— å¦'}<br>
        æ˜¯å¦ Standalone: ${window.matchMedia('(display-mode: standalone)').matches ? 'âœ“ æ˜¯' : 'âœ— å¦'}
      </small>
    `;

    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      suggestions.push('âš ï¸ å¿…é¡»ä½¿ç”¨ HTTPSï¼ˆVercel è‡ªåŠ¨æä¾›ï¼‰');
    }

    // æ˜¾ç¤ºå»ºè®®
    setTimeout(() => {
      const suggestionsEl = document.getElementById('suggestions');
      if (suggestions.length === 0) {
        suggestionsEl.innerHTML = `<span class="status success">âœ“ é…ç½®æ­£å¸¸</span><br>` +
          `<small>å¦‚æœå®‰è£…æç¤ºä»æœªå‡ºç°ï¼Œè¯·ï¼š<br>` +
          `1. ç‚¹å‡»é¡µé¢ä»»æ„ä½ç½®ï¼ˆæ»¡è¶³äº¤äº’è¦æ±‚ï¼‰<br>` +
          `2. ç­‰å¾… 30 ç§’ä»¥ä¸Šï¼ˆæ»¡è¶³åœç•™æ—¶é—´è¦æ±‚ï¼‰<br>` +
          `3. æˆ–è€…æ‰‹åŠ¨å®‰è£…ï¼šChrome èœå• â†’ "å®‰è£…åº”ç”¨"</small>`;
      } else {
        suggestionsEl.innerHTML = suggestions.map(s => 
          `<div style="margin: 10px 0;">âš ï¸ ${s}</div>`
        ).join('');
      }
    }, 2000);
  </script>
</body>
</html>
