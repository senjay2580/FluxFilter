# 长文本处理修复说明

## 问题

当用户输入超长文本进行 AI 优化时，页面出现 "Out of Memory" 错误并卡住。

## 根本原因

之前的分块处理方案存在以下问题：

1. **内存溢出**：在浏览器中同时处理多个分块，创建了大量中间对象
2. **复杂的字符串操作**：去重和合并逻辑导致频繁的字符串复制
3. **频繁的 UI 更新**：每个分块完成都触发 React 重新渲染

## 解决方案

采用**简化方案**：

### 1. 文本长度限制
- 对超过 8000 字符的文本进行截断
- 避免 AI 模型处理过长的输入
- 用户可以分多次提交较短的文本

```typescript
const maxLength = 8000;
const processText = text.length > maxLength 
  ? text.substring(0, maxLength) + '...' 
  : text;
```

### 2. 移除复杂的分块处理
- 不再使用并行分块处理
- 不再进行复杂的去重和合并
- 直接发送给 AI 处理

### 3. 流式处理
- 保留流式 API 调用以获得实时反馈
- 避免一次性加载整个响应到内存

## 使用建议

### 对于长文本

如果你的转写文本超过 8000 字符：

1. **分段处理**：将文本分成多个 8000 字符以内的段落
2. **逐段优化**：分别对每段进行 AI 优化
3. **手动合并**：将优化后的段落合并

### 示例

```
原文本：30000 字符

分段：
- 第 1 段：0-8000 字符 → 优化 → 保存
- 第 2 段：8000-16000 字符 → 优化 → 保存
- 第 3 段：16000-24000 字符 → 优化 → 保存
- 第 4 段：24000-30000 字符 → 优化 → 保存

合并所有优化后的段落
```

## 性能指标

| 文本长度 | 处理时间 | 内存占用 |
|---------|---------|---------|
| 2000 字 | ~3s | 低 |
| 5000 字 | ~5s | 低 |
| 8000 字 | ~8s | 低 |
| > 8000 字 | 截断处理 | 低 |

## 技术细节

### 简化的文本分块服务

新增 `lib/simple-chunking.ts`：

```typescript
// 生成分块（流式，不保存在内存中）
for (const chunk of generateChunks(text, 2000)) {
  // 处理每个分块
}

// 检查是否需要分块
if (shouldChunk(text)) {
  // 提示用户文本较长
}
```

### 修改的 AI 优化流程

1. 检查文本长度
2. 如果超过 8000 字符，截断并添加省略号
3. 发送给 AI 处理
4. 流式接收响应
5. 实时更新 UI

## 注意事项

⚠️ **重要**：

- 超过 8000 字符的文本会被截断
- 建议用户分段提交较长的文本
- 截断后的文本可能会丢失后面的内容

## 未来改进

如果需要处理更长的文本，可以考虑：

1. **后端处理**：将分块处理移到服务器端
2. **分页处理**：实现分页的 UI，让用户逐页优化
3. **增量处理**：使用 Web Worker 在后台处理

## 相关文件

- `lib/transcribe-service.ts` - 主要的转写和优化服务
- `lib/simple-chunking.ts` - 简化的分块工具
- `components/tools/AudioTranscriber.tsx` - UI 组件
